## 쿠키

상당히 많이 사용하고 중요하다

쿠키는 중요하기 때문에 자세히 설명한다

쿠키를 사용할때는 아래의 두가지 헤더를 사용한다

- Set-Cookie: 서버에서 클라이언트로 쿠키 전달( 응답 )


- Cookie: 클라이언트가 서버에서 받은 쿠키를 저장하고, HTTP 요청시 서버로 전달

---

### 쿠키 미사용
#### 처음 welcome 페이지 접근

> 웹 브라우저
>
> ---
>
> GET /welcome HTTP/1.1

-->

> 서버
> 
> ---
> 
> HTTP/1.1 200 OK
> 
> ````text
> 안녕하세요. 손님
> ````

<--

---

### 쿠키 미사용
#### 로그인

> 웹 브라우저
> 
> ---
> 
> POST /**login** HTTP/1.1
> 
> user=홍길동

-->

> 서버
> 
> ---
> 
> HTTP/1.1 200 OK
>
> ````text
> 홍길동님이 로그인했습니다
> ````

<--

---

### 쿠키 미사용
#### 로그인 이후 welcome 페이지 접근

> 웹 브라우저
>
> ---
>
> GET /**welcome** HTTP/1.1

-->

> 서버
>
> ---
>
> HTTP/1.1 200 OK
>
> ````text
> 안녕하세요. 손님
> ````

<--

- 로그인을 했지만, welcome 페이지에 접근해도, **안녕하세요. 손님**을 내린다
  - GET 메서드로 /welcome 만 보냈는데 서버에서 이것이 로그인한 사용자인지 구분할 방법이 없다
---
  
### Stateless

- HTTP 는 무상태( Stateless ) 프로토콜이다.


- 클라이언트와 서버가 요청과 응답을 주고 받으면 연결이 끊어진다.


- 클라이언트가 다시 요청하면 서버는 이전 요청을 기억하지 못한다.


- 클라이언트와 서버는 서로 상태를 유지하지 않는다.

HTTP 는 기본적으로 무상태 프로토콜이라 서버와 연결이 끊어진다
( 이전 요청을 기억하지 못함 -> 여기서 문제가 발생 -> 안녕하세요. 손님!! - 너가누군데)


---

### 쿠키 미사용
#### 대안 - 모든 요청에 사용자 정보 포함

> 웹 브라우저
>
> ---
>
> GET /**welcome?user=홍길동** HTTP/1.1

-->

> 서버
>
> ---
>
> HTTP/1.1 200 OK
>
> ````text
> 안녕하세요. 홍길동님
> ````

<--

- 대안은 유저정보를 계속 서버에 주면, 서버는 그 값을 받아서 처리하면 된다

---

### 쿠키 미사용
#### 대안 - 모든 요청과 링크에 사용자 정보 포함?

> 웹 브라우저
> 
> ---
> 
> GET /welcome?user=홍길동 HTTP/1.1

> 웹 브라우저
>
> ---
>
> GET /board?user=홍길동 HTTP/1.1

> 웹 브라우저
>
> ---
>
> GET /order?user=홍길동 HTTP/1.1

> 웹 브라우저
>
> ---
>
> GET /xxx...?user=홍길동 HTTP/1.1

- 이 대안은 심각한 문제가 모든 요청과 링크에 사용자 정보를 다포함해야한다
  - 보안에도 문제가 있고 여러가지 심각한 문제가 발생한다

---

### 모든 요청에 정보를 넘기는 문제

- 모든 요청에 사용자 정보가 포함되도록 개발 해야함
  - 개발이 엄청 힘듬


- 브라우저를 완전히 종료하고 다시 열면?
  - 요새는 WebStorage 라는게 있어서, 거기에 저장해두면 된다
  - 하지만, 이렇게 하기에는 너무 힘들다

---

### 쿠키
#### 로그인

옛날부터 이런 문제점이 있었기 때문에, 이것을 해결하기 위하여 쿠키라는 개념이 도입되었다

> 웹 브라우저
> 
> ---
> 
> POST /**login** HTTP/1.1
> 
> user=홍길동

-->

> 서버
> 
> ---
> 
> HTTP/1.1 200 OK
> 
> Set-Cookie: user=홍길동
> 
> ````text
> 홍길동님이 로그인했습니다
> ````

- Set-Cookie 로 user=홍길동이라는 정보를 cookie 헤더를 만들어서 만다


- cookie 에 말아서 응답을 한다

<--

> 쿠키 저장소
> ( 쿠키 저장소에 저장 )
> 
> ---
> 
> user=홍길동

- 그러면 웹 브라우저는 웹 브라우저 내부의 쿠키 저장소에 user=홍길동 이라는 정보를 저장해둔다


- 서버가 응답에서 만든 Set-Cookie 라고 보낸 "user=홍길동" 값을 쿠키 저장소에 저장해둔다


- 서버 입장에서는 로그인이 성공하면 이런 정보를 말아둔다

---

### 쿠키
#### 로그인 이후 welcome 접근

- 로그인 이후에 웹 브라우저가 welcome 페이지에 들어오면, 자동으로 웹 브라우저는 서버에 요청을 보낼때마다 cookie 를 무조건 뒤진다.


- cookie 값을 무조건 꺼내서, **Cookie: user=홍길동** 이라는 정보를 맨들어서 서버에 보낸다


- 서버는 cookie 를 열어보면 user=홍길동 이라는 것을 알 수 있다
  - ( 지저분하게 URL 에 넣거나 할 필요가 없다 )


> 웹 브라우저
>
> ---
>
> POST /**welcome** HTTP/1.1
>
> Cookie: user=홍길동

-->

> 서버
>
> ---
>
> HTTP/1.1 200 OK
>
> ````text
> 안녕하세요. 홍길동님
> ````

<--


> 쿠키 저장소
> ( 쿠키 저장소에서 조회 )
>
> ---
>
> user=홍길동

---

### 쿠키
#### 모든 요청에 쿠키 정보 자동 포함

> 웹 브라우저
> 
> 쿠키 저장소( user=홍길동 )
>
> ---
>
> GET /welcome?user=홍길동 HTTP/1.1
> 
> Cookie: user=홍길동

> 웹 브라우저
> 
> 쿠키 저장소( user=홍길동 )
>
> ---
>
> GET /board?user=홍길동 HTTP/1.1
>
> Cookie: user=홍길동

> 웹 브라우저
> 
> 쿠키 저장소( user=홍길동 )
>
> ---
>
> GET /order?user=홍길동 HTTP/1.1
>
> Cookie: user=홍길동

> 웹 브라우저
> 
> 쿠키 저장소( user=홍길동 )
>
> ---
>
> GET /xxx...?user=홍길동 HTTP/1.1
> 
> Cookie: user=홍길동

- 웹 브라우저가 뭐로 보내는 지정한 서버에 대해서는 cookie 의 데이터를 자동으로 다 뽑아가지고, cookie 를 자동으로 보내준다


- 따라서, 개발자가 따로 뭔가를 처리하지 않고 cookie 메커니즘으로 자동으로 처리할 수 있다.

---

### 쿠키

그런데 정말 모든곳에 쿠키정보를 보내면 보안에 문제가 있어서 제약하는 방법이 있다

> 서버에서 cookie 를 세팅할때
> 
> ---
> 
> expires : 쿠키가 만료되는 시점
> 
> path : 해당 경로에 허용 
> 
> domain : 이러한 도메인에 대한 허용
> 
> Secure : 쿠키의 보안 정보

- 로그인을 했을때, **user=홍길동** 이라는 정보를 그대로 내리는 것은 매우 위험하다

- 로그인이 성공하면 sessionKey 라는 것을 맨들어서 데이터베이스에 저장을 해두고, 
  - sessionId=??? 라고 해서 클라이언트에 반환을 해준다
  - 그러면 클라이언트는 서버에 요청할때마다 sessionId 를 계속 보낸다
  - 그러면 서버는 sessionId 가 있으면 사용자를 구분할 수 있다

---

- 예) set-cookie: **sessionId=abcde1234**; **expires**=Sat, 26-Dec-2020 00:00:00 GMT; **path**=/; **domain**=.google.com; **Secure**


- 사용처
  - 사용자 로그인 세션 관리
  - 광고 정보 트래킹
    - 이런 웹브라우저를 보는 사람이 이런이런 광고를 주로보는구나!!


- 쿠키 정보는 항상 서버에 전송됨
  - 네트웨크 트래픽 추가 유발( 정보가 더 넘어가기 때문... )
  - 최소한의 정보만 사용( 세션 id, 인증 토큰 )
  - 서버에 전송하지 않고, 웹 브라우저 내부에 데이터를 저장하고 싶으면 **웹 스토리지 ( localStorage, sessionStorage )** 참고


- 주의!
  - 보안에 민감한 데이터는 저장하면 안됨( 주민번호, 신용카드 번호 등등 )
    - 웹 스토리지도 마찬가지다

쿠키는 세팅하면 일단 무조건 서버로 보내버린다( 쿠키가 100 개가 되면 큰일날듯... )
100 개의 데이터가 계속 서버로 전송...

따라서, 클라이언트에 저장해두고, 클라이언트 로직에서만 처리해야 할 경우에는 **웹 스토리지**를 사용 

---

### 쿠키 - 생명주기
#### Expires, max-age

- Set-Cookie: **expires**=Sat, 26-Dec-2020 04:39:21 GMT
  - 만료일이 되면 쿠키 삭제


- Set-Cookie: **max-age**=3600( 3600초 )
  - 0이나 음수를 지정하면 쿠키 삭제


- 세션 쿠키: **만료 날짜를 생략하면 브라우저 종료시 까지만 유지**


- 영속 쿠키: **만료 날짜를 입력하면 해당 날짜까지 유지**

---

### 쿠키-도메인
#### Domain

- 예) domain=example.org


- **명시: 명시한 문서 기준 도메인 + 서브 도메인 포함**


- domain=example.org 를 지정해서 쿠키 생성
  - example.org 는 물론이고
  - dev.example.org 도 쿠키 접근


- **생략: 현재 문서 기준 도메인만 적용**
  - example.org 에서 쿠키를 생성하고 domain 지정을 생략
    - example.org 에서만 쿠키 접근
    - dev.example.org 는 쿠키 미접근

---

### 쿠키-경로
#### Path

- 예) path=/home


- **이 경로를 포함한 하위 경로 페이지만 쿠키 접근**


- **일반적으로 path=/ 루트로 지정**
  - 왜냐면, 한 도메인 안에서 쿠키를 다 전송하기를 원함


- 예) **path=/home 지정했을 경우** 쿠키가 전달
  - /home -> 접근 가능
  - /home/level1 -> 접근 가능
  - /home/level1/level2 -> 접근 가능
  - /hello -> 불가능
    - path=/home 인데 /hello 면 레벨이 맞지 않아서 쿠키가 전달되지 않는다

---

### 쿠키-보안
#### Secure, HttpOnly, SameSite

- Secure
  - 쿠키는 http, https 를 구분하지 않고 전송
  - Secure 를 적용하면 https 인 경우에만 전송


- HttpOnly
  - XSS 공격 방지
  - 자바스크립트에서 접근 불가( document.cookie )
  - HTTP 전송에만 사용


- SameSite
  - XSRF 공격 방지
  - 요청 도메인과 쿠키에 설정된 도메인이 같은 경우에만 쿠키 전송
    - 요청 도메인과 쿠키가 설정된 도메인이 달라도 쿠키를 전송할 수 있지만 그것을 막는것.
    - ( 다른 사이트에서 쿠키를 세팅해서 )
    - 기능이 적용된지 얼마 안되서 브라우저에서 어느정도 지원하는지를 확인해봐야한다